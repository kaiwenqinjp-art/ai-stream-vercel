const reader = response.body.getReader();
const decoder = new TextDecoder();
let buffer = '';

while (true) {
    const { done, value } = await reader.read();
    if (done) break;

    buffer += decoder.decode(value, { stream: true });

    // Process all full SSE events
    let parts = buffer.split('\n\n');

    // Leave incomplete chunk for next loop
    buffer = parts.pop();

    for (const part of parts) {
        if (!part.trim().startsWith('data:')) continue;

        const jsonStr = part.trim().replace(/^data:\s*/, '');
        
        let payload;
        try {
            payload = JSON.parse(jsonStr);
        } catch (e) {
            continue; // ignore incomplete JSON
        }

        if (payload.chunk) {
            this.output.textContent += payload.chunk;
            this.charNum += payload.chunk.length;
            this.charCount.textContent = this.charNum;
            this.output.scrollTop = this.output.scrollHeight;
        }

        if (payload.done) {
            console.log("Stream finished.");
            return;
        }
    }
}
